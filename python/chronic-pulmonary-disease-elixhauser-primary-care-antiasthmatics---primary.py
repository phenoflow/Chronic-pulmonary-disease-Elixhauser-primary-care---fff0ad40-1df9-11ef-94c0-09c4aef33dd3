# David Metcalfe, James Masters, Antonella Delmestri, Andrew Judge, Daniel Perry, Cheryl Zogg, Belinda Gabbe, Matthew Costa, 2024.

import sys, csv, re

codes = [{"code":"H312000","system":"readv2"},{"code":"663s.00","system":"readv2"},{"code":"9hA1.00","system":"readv2"},{"code":"663P.00","system":"readv2"},{"code":"9hA2.00","system":"readv2"},{"code":"493 HR","system":"readv2"},{"code":"2126200","system":"readv2"},{"code":"493 JC","system":"readv2"},{"code":"9OJA.00","system":"readv2"},{"code":"663O000","system":"readv2"},{"code":"663n.00","system":"readv2"},{"code":"493 EP","system":"readv2"},{"code":"H331.00","system":"readv2"},{"code":"9OJ2.00","system":"readv2"},{"code":"1788.00","system":"readv2"},{"code":"493 KA","system":"readv2"},{"code":"663x.00","system":"readv2"},{"code":"H33z200","system":"readv2"},{"code":"493 BI","system":"readv2"},{"code":"H33z111","system":"readv2"},{"code":"66Yp.00","system":"readv2"},{"code":"173A.00","system":"readv2"},{"code":"H33zz12","system":"readv2"},{"code":"663Q.00","system":"readv2"},{"code":"6.6300000000e+102","system":"readv2"},{"code":"H331100","system":"readv2"},{"code":"663e.00","system":"readv2"},{"code":"66YJ.00","system":"readv2"},{"code":"663U.00","system":"readv2"},{"code":"679J200","system":"readv2"},{"code":"9OJ4.00","system":"readv2"},{"code":"H330.00","system":"readv2"},{"code":"66Y5.00","system":"readv2"},{"code":"493 EB","system":"readv2"},{"code":"66Yr.00","system":"readv2"},{"code":"1783.00","system":"readv2"},{"code":"493 HT","system":"readv2"},{"code":"1786.00","system":"readv2"},{"code":"9OJ6.00","system":"readv2"},{"code":"9OJZ.00","system":"readv2"},{"code":"U60F61A","system":"readv2"},{"code":"H331111","system":"readv2"},{"code":"661M100","system":"readv2"},{"code":"663v.00","system":"readv2"},{"code":"663p.00","system":"readv2"},{"code":"L4930LO","system":"readv2"},{"code":"663","system":"readv2"},{"code":"TJF7z00","system":"readv2"},{"code":"13Y4.00","system":"readv2"},{"code":"493 AJ","system":"readv2"},{"code":"663V000","system":"readv2"},{"code":"1780.00","system":"readv2"},{"code":"493 EA","system":"readv2"},{"code":"H33z100","system":"readv2"},{"code":"H35y700","system":"readv2"},{"code":"H332.00","system":"readv2"},{"code":"9N1d.00","system":"readv2"},{"code":"66YK.00","system":"readv2"},{"code":"663e100","system":"readv2"},{"code":"9OJ..00","system":"readv2"},{"code":"H33zz11","system":"readv2"},{"code":"38DT.00","system":"readv2"},{"code":"9OJ9.00","system":"readv2"},{"code":"663q.00","system":"readv2"},{"code":"493","system":"readv2"},{"code":"1781.00","system":"readv2"},{"code":"663r.00","system":"readv2"},{"code":"663e000","system":"readv2"},{"code":"493 GS","system":"readv2"},{"code":"H47y000","system":"readv2"},{"code":"66YZ.00","system":"readv2"},{"code":"8795.00","system":"readv2"},{"code":"66YE.00","system":"readv2"},{"code":"679J.00","system":"readv2"},{"code":"663f.00","system":"readv2"},{"code":"66YQ.00","system":"readv2"},{"code":"8798.00","system":"readv2"},{"code":"U60F615","system":"readv2"},{"code":"8CR0.00","system":"readv2"},{"code":"H331.11","system":"readv2"},{"code":"8CMA000","system":"readv2"},{"code":"663V100","system":"readv2"},{"code":"H330100","system":"readv2"},{"code":"178B.00","system":"readv2"},{"code":"U60F600","system":"readv2"},{"code":"493 BD","system":"readv2"},{"code":"9OJ8.00","system":"readv2"},{"code":"8791.00","system":"readv2"},{"code":"H33z011","system":"readv2"},{"code":"663V.00","system":"readv2"},{"code":"679J100","system":"readv2"},{"code":"493 AA","system":"readv2"},{"code":"1789.00","system":"readv2"},{"code":"66Y9.00","system":"readv2"},{"code":"663P000","system":"readv2"},{"code":"66YA.00","system":"readv2"},{"code":"9OJA.11","system":"readv2"},{"code":"663..11","system":"readv2"},{"code":"388t000","system":"readv2"},{"code":"9Q21.00","system":"readv2"},{"code":"66Yu.00","system":"readv2"},{"code":"663y.00","system":"readv2"},{"code":"66YC.00","system":"readv2"},{"code":"38DV.00","system":"readv2"},{"code":"H330011","system":"readv2"},{"code":"493 AI","system":"readv2"},{"code":"691 TM","system":"readv2"},{"code":"1O2..00","system":"readv2"},{"code":"8796.00","system":"readv2"},{"code":"173d.00","system":"readv2"},{"code":"663N000","system":"readv2"},{"code":"H333.00","system":"readv2"},{"code":"1782.00","system":"readv2"},{"code":"H331z00","system":"readv2"},{"code":"H330111","system":"readv2"},{"code":"8B3j.00","system":"readv2"},{"code":"H330.12","system":"readv2"},{"code":"1785.00","system":"readv2"},{"code":"h33z100","system":"readv2"},{"code":"178..00","system":"readv2"},{"code":"663j.00","system":"readv2"},{"code":"663N200","system":"readv2"},{"code":"H33..00","system":"readv2"},{"code":"H330.13","system":"readv2"},{"code":"66Yq.00","system":"readv2"},{"code":"663N.00","system":"readv2"},{"code":"U60F611","system":"readv2"},{"code":"663h.00","system":"readv2"},{"code":"178A.00","system":"readv2"},{"code":"1784.00","system":"readv2"},{"code":"663V200","system":"readv2"},{"code":"493 BG","system":"readv2"},{"code":"H33..11","system":"readv2"},{"code":"9OJ3.00","system":"readv2"},{"code":"SLF7z00","system":"readv2"},{"code":"679J000","system":"readv2"},{"code":"663O.00","system":"readv2"},{"code":"663W.00","system":"readv2"},{"code":"H330.14","system":"readv2"},{"code":"8CE2.00","system":"readv2"},{"code":"493 BR","system":"readv2"},{"code":"661N100","system":"readv2"},{"code":"493 AD","system":"readv2"},{"code":"H331000","system":"readv2"},{"code":"H33zz00","system":"readv2"},{"code":"8797.00","system":"readv2"},{"code":"9OJ7.00","system":"readv2"},{"code":"H330z00","system":"readv2"},{"code":"H334.00","system":"readv2"},{"code":"66YP.00","system":"readv2"},{"code":"14B4.00","system":"readv2"},{"code":"TJF7.00","system":"readv2"},{"code":"9NI8.00","system":"readv2"},{"code":"8H2P.00","system":"readv2"},{"code":"9NNX.00","system":"readv2"},{"code":"66Ys.00","system":"readv2"},{"code":"H330000","system":"readv2"},{"code":"493 NA","system":"readv2"},{"code":"663P200","system":"readv2"},{"code":"663P100","system":"readv2"},{"code":"9OJ1.00","system":"readv2"},{"code":"H330.11","system":"readv2"},{"code":"8793.00","system":"readv2"},{"code":"H33z.00","system":"readv2"},{"code":"8794.00","system":"readv2"},{"code":"1787.00","system":"readv2"},{"code":"9OJ5.00","system":"readv2"},{"code":"493 KB","system":"readv2"},{"code":"9hA..00","system":"readv2"},{"code":"173c.00","system":"readv2"},{"code":"663N100","system":"readv2"},{"code":"663t.00","system":"readv2"},{"code":"663m.00","system":"readv2"},{"code":"493 AB","system":"readv2"},{"code":"663u.00","system":"readv2"},{"code":"493 GR","system":"readv2"},{"code":"663V300","system":"readv2"},{"code":"663w.00","system":"readv2"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('chronic-pulmonary-disease-elixhauser-primary-care-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["chronic-pulmonary-disease-elixhauser-primary-care-antiasthmatics---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["chronic-pulmonary-disease-elixhauser-primary-care-antiasthmatics---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["chronic-pulmonary-disease-elixhauser-primary-care-antiasthmatics---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
